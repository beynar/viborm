{"version":3,"file":"sql-CFtZ-oR0.mjs","names":["values"],"sources":["../src/sql/sql.ts"],"sourcesContent":["/**\n * Values supported by SQL engine.\n */\nexport type Value = unknown;\n\n/**\n * Supported value or SQL instance.\n */\nexport type RawValue = Value | Sql;\n\n/**\n * A SQL instance can be nested within each other to build SQL strings.\n */\nexport class Sql {\n  readonly values: Value[];\n  readonly strings: string[];\n\n  constructor(rawStrings: readonly string[], rawValues: readonly RawValue[]) {\n    if (rawStrings.length - 1 !== rawValues.length) {\n      if (rawStrings.length === 0) {\n        throw new TypeError(\"Expected at least 1 string\");\n      }\n      throw new TypeError(\n        `Expected ${rawStrings.length} strings to have ${\n          rawStrings.length - 1\n        } values`\n      );\n    }\n\n    const valuesLength = rawValues.reduce<number>(\n      (len, value) => len + (value instanceof Sql ? value.values.length : 1),\n      0\n    );\n\n    this.values = new Array(valuesLength);\n    this.strings = new Array(valuesLength + 1);\n\n    this.strings[0] = rawStrings[0]!;\n\n    // Iterate over raw values, strings, and children. The value is always\n    // positioned between two strings, e.g. `index + 1`.\n    let i = 0,\n      pos = 0;\n    while (i < rawValues.length) {\n      const child = rawValues[i++]!;\n      const rawString = rawStrings[i]!;\n\n      // Check for nested `sql` queries.\n      if (child instanceof Sql) {\n        // Append child prefix text to current string.\n        this.strings[pos] += child.strings[0]!;\n\n        let childIndex = 0;\n        while (childIndex < child.values.length) {\n          this.values[pos++] = child.values[childIndex++]!;\n          this.strings[pos] = child.strings[childIndex]!;\n        }\n\n        // Append raw string to current string.\n        this.strings[pos] += rawString;\n      } else {\n        this.values[pos++] = child;\n        this.strings[pos] = rawString;\n      }\n    }\n  }\n\n  toStatement(placeholder: \"$n\" | \":n\" | \"?\" = \"?\") {\n    const len = this.strings.length;\n    let i = 1;\n    let value = this.strings[0]!;\n    while (i < len) value += `${placeholder}${i}${this.strings[i++]!}`;\n    return value;\n  }\n}\n\nfunction spreadValues(...data: Array<Record<string, RawValue>>) {\n  const firstRow = data[0]!;\n  // Assuming all rows have the same keys\n  const valueKeys = Object.keys(firstRow) as string[];\n  const allLengths = new Set();\n\n  const values = data.map((item, index) => {\n    const keys = Object.keys(item);\n    const values = keys.map((key) => item[key]);\n    allLengths.add(values.length);\n    return new Sql([\"(\", ...Array(keys.length - 1).fill(\",\"), \")\"], values);\n  });\n\n  if (allLengths.size > 1) {\n    throw new TypeError(\n      \"All inserted rows must have the same number of values\"\n    );\n  }\n\n  allLengths.clear();\n\n  return new Sql(\n    [\n      `(${valueKeys.join(\",\")}) VALUES `,\n      ...Array(values.length - 1).fill(\",\"),\n      \")\",\n    ],\n    values\n  );\n}\n\n/**\n * Create raw SQL statement.\n */\nfunction raw(strings: readonly string[], ...values: readonly RawValue[]) {\n  const concatenated = strings.reduce((acc, string, index) => {\n    return acc + string + (values[index] ?? \"\");\n  }, \"\");\n  return new Sql([concatenated], []);\n}\n\nconst wrap = (prefix: string, wrapped: Sql | undefined, suffix: string) => {\n  return wrapped\n    ? empty\n    : sql`${new Sql([prefix], [])}${wrapped}${new Sql([suffix], [])}`;\n};\n\n/**\n * Create a SQL query for a list of values.\n */\nfunction join(\n  values: readonly Sql[],\n  separator = \",\",\n  prefix = \"\",\n  suffix = \"\"\n) {\n  return new Sql(\n    [prefix, ...Array(values.length - 1).fill(separator), suffix],\n    values\n  );\n}\n\n/**\n * Placeholder value for \"no text\".\n */\nconst empty = raw``;\n\n/**\n * Create a SQL object from a template string.\n */\nfunction sql(strings: readonly string[], ...values: readonly RawValue[]) {\n  return new Sql(strings, values);\n}\n\nconst sqlProxy = new Proxy(sql, {\n  get(target, prop) {\n    if (prop === \"raw\") {\n      return raw;\n    }\n    if (prop === \"spreadValues\") {\n      return spreadValues;\n    }\n    if (prop === \"empty\") {\n      return empty;\n    }\n    if (prop === \"wrap\") {\n      return wrap;\n    }\n    if (prop === \"join\") {\n      return join;\n    }\n    return (strings: TemplateStringsArray, ...values: RawValue[]) => {\n      return target(strings, ...values);\n    };\n  },\n}) as typeof sql & {\n  raw: typeof raw;\n  wrap: typeof wrap;\n  spreadValues: typeof spreadValues;\n  empty: typeof empty;\n  join: typeof join;\n};\n\nexport { sqlProxy as sql };\n"],"mappings":"AAaA,IAAa,EAAb,MAAa,CAAI,CAIf,YAAY,EAA+B,EAAgC,CACzE,GAAI,EAAW,OAAS,IAAM,EAAU,OAItC,MAHI,EAAW,SAAW,EACd,UAAU,6BAA6B,CAEzC,UACR,YAAY,EAAW,OAAO,mBAC5B,EAAW,OAAS,EACrB,SACF,CAGH,IAAM,EAAe,EAAU,QAC5B,EAAK,IAAU,GAAO,aAAiB,EAAM,EAAM,OAAO,OAAS,GACpE,EACD,CAED,KAAK,OAAa,MAAM,EAAa,CACrC,KAAK,QAAc,MAAM,EAAe,EAAE,CAE1C,KAAK,QAAQ,GAAK,EAAW,GAI7B,IAAI,EAAI,EACN,EAAM,EACR,KAAO,EAAI,EAAU,QAAQ,CAC3B,IAAM,EAAQ,EAAU,KAClB,EAAY,EAAW,GAG7B,GAAI,aAAiB,EAAK,CAExB,KAAK,QAAQ,IAAQ,EAAM,QAAQ,GAEnC,IAAI,EAAa,EACjB,KAAO,EAAa,EAAM,OAAO,QAC/B,KAAK,OAAO,KAAS,EAAM,OAAO,KAClC,KAAK,QAAQ,GAAO,EAAM,QAAQ,GAIpC,KAAK,QAAQ,IAAQ,OAErB,KAAK,OAAO,KAAS,EACrB,KAAK,QAAQ,GAAO,GAK1B,YAAY,EAAiC,IAAK,CAChD,IAAM,EAAM,KAAK,QAAQ,OACrB,EAAI,EACJ,EAAQ,KAAK,QAAQ,GACzB,KAAO,EAAI,GAAK,GAAS,GAAG,IAAc,IAAI,KAAK,QAAQ,OAC3D,OAAO,IAIX,SAAS,EAAa,GAAG,EAAuC,CAC9D,IAAM,EAAW,EAAK,GAEhB,EAAY,OAAO,KAAK,EAAS,CACjC,EAAa,IAAI,IAEjB,EAAS,EAAK,KAAK,EAAM,IAAU,CACvC,IAAM,EAAO,OAAO,KAAK,EAAK,CACxBA,EAAS,EAAK,IAAK,GAAQ,EAAK,GAAK,CAE3C,OADA,EAAW,IAAIA,EAAO,OAAO,CACtB,IAAI,EAAI,CAAC,IAAK,GAAG,MAAM,EAAK,OAAS,EAAE,CAAC,KAAK,IAAI,CAAE,IAAI,CAAEA,EAAO,EACvE,CAEF,GAAI,EAAW,KAAO,EACpB,MAAU,UACR,wDACD,CAKH,OAFA,EAAW,OAAO,CAEX,IAAI,EACT,CACE,IAAI,EAAU,KAAK,IAAI,CAAC,WACxB,GAAG,MAAM,EAAO,OAAS,EAAE,CAAC,KAAK,IAAI,CACrC,IACD,CACD,EACD,CAMH,SAAS,EAAI,EAA4B,GAAG,EAA6B,CAIvE,OAAO,IAAI,EAAI,CAHM,EAAQ,QAAQ,EAAK,EAAQ,IACzC,EAAM,GAAU,EAAO,IAAU,IACvC,GAAG,CACuB,CAAE,EAAE,CAAC,CAGpC,MAAM,GAAQ,EAAgB,EAA0B,IAC/C,EACH,EACA,CAAG,GAAG,IAAI,EAAI,CAAC,EAAO,CAAE,EAAE,CAAC,GAAG,IAAU,IAAI,EAAI,CAAC,EAAO,CAAE,EAAE,CAAC,GAMnE,SAAS,EACP,EACA,EAAY,IACZ,EAAS,GACT,EAAS,GACT,CACA,OAAO,IAAI,EACT,CAAC,EAAQ,GAAG,MAAM,EAAO,OAAS,EAAE,CAAC,KAAK,EAAU,CAAE,EAAO,CAC7D,EACD,CAMH,MAAM,EAAQ,CAAG,GAKjB,SAAS,EAAI,EAA4B,GAAG,EAA6B,CACvE,OAAO,IAAI,EAAI,EAAS,EAAO,CAGjC,MAAM,EAAW,IAAI,MAAM,EAAK,CAC9B,IAAI,EAAQ,EAAM,CAgBhB,OAfI,IAAS,MACJ,EAEL,IAAS,eACJ,EAEL,IAAS,QACJ,EAEL,IAAS,OACJ,EAEL,IAAS,OACJ,GAED,EAA+B,GAAG,IACjC,EAAO,EAAS,GAAG,EAAO,EAGtC,CAAC"}