import{n as e}from"./postgres-adapter-CzPH7ypE.mjs";function t(e,t){return e.name===t.name&&n(e.type)===n(t.type)&&e.nullable===t.nullable&&r(e.default)===r(t.default)}function n(e){let t=e.toLowerCase().trim();return{int4:`integer`,int8:`bigint`,int2:`smallint`,float4:`real`,float8:`double precision`,bool:`boolean`,timestamptz:`timestamp with time zone`,timetz:`time with time zone`}[t]||t}function r(e){if(e===void 0)return;let t=e.trim().toLowerCase();return t===`null`?`null`:t===`true`||t===`'t'`||t===`1`?`true`:t===`false`||t===`'f'`||t===`0`?`false`:e}function i(e,t){return e.name===t.name&&e.unique===t.unique&&s(e.columns,t.columns)&&e.type===t.type&&e.where===t.where}function a(e,t){return e.name===t.name&&s(e.columns,t.columns)&&e.referencedTable===t.referencedTable&&s(e.referencedColumns,t.referencedColumns)&&e.onDelete===t.onDelete&&e.onUpdate===t.onUpdate}function o(e,t){return e.name===t.name&&s(e.columns,t.columns)}function s(e,t){return e.length===t.length?e.every((e,n)=>e===t[n]):!1}function c(e,t){return e.name===t.name&&s(e.values,t.values)}function l(e,r,c){let l=[],u=[],d=new Map(r.columns.map(e=>[e.name,e])),f=new Map(c.columns.map(e=>[e.name,e])),p=[],m=[];for(let[e,t]of d)f.has(e)||p.push(t);for(let[e,t]of f)d.has(e)||m.push(t);let h=new Set,g=new Set;for(let t of p)for(let r of m)h.has(t.name)||g.has(r.name)||n(t.type)===n(r.type)&&(u.push({type:`ambiguousColumn`,tableName:e,droppedColumn:t,addedColumn:r}),h.add(t.name),g.add(r.name));for(let t of p)h.has(t.name)||l.push({type:`dropColumn`,tableName:e,columnName:t.name});for(let t of m)g.has(t.name)||l.push({type:`addColumn`,tableName:e,column:t});for(let[n,r]of f){let i=d.get(n);i&&!t(i,r)&&l.push({type:`alterColumn`,tableName:e,columnName:n,from:i,to:r})}let _=new Map(r.indexes.map(e=>[e.name,e])),v=new Map(c.indexes.map(e=>[e.name,e]));for(let[t,n]of _){let r=v.get(t);r?i(n,r)||(l.push({type:`dropIndex`,indexName:t}),l.push({type:`createIndex`,tableName:e,index:r})):l.push({type:`dropIndex`,indexName:t})}for(let[t,n]of v)_.has(t)||l.push({type:`createIndex`,tableName:e,index:n});let y=new Map(r.foreignKeys.map(e=>[e.name,e])),b=new Map(c.foreignKeys.map(e=>[e.name,e]));for(let[t,n]of y){let r=b.get(t);r?a(n,r)||(l.push({type:`dropForeignKey`,tableName:e,fkName:t}),l.push({type:`addForeignKey`,tableName:e,fk:r})):l.push({type:`dropForeignKey`,tableName:e,fkName:t})}for(let[t,n]of b)y.has(t)||l.push({type:`addForeignKey`,tableName:e,fk:n});let x=new Map(r.uniqueConstraints.map(e=>[e.name,e])),S=new Map(c.uniqueConstraints.map(e=>[e.name,e]));for(let[t,n]of x){let r=S.get(t);r?o(n,r)||(l.push({type:`dropUniqueConstraint`,tableName:e,constraintName:t}),l.push({type:`addUniqueConstraint`,tableName:e,constraint:r})):l.push({type:`dropUniqueConstraint`,tableName:e,constraintName:t})}for(let[t,n]of S)x.has(t)||l.push({type:`addUniqueConstraint`,tableName:e,constraint:n});let C=r.primaryKey,w=c.primaryKey;return C&&!w?l.push({type:`dropPrimaryKey`,tableName:e,constraintName:C.name||`${e}_pkey`}):!C&&w?l.push({type:`addPrimaryKey`,tableName:e,primaryKey:w}):C&&w&&!s(C.columns,w.columns)&&(l.push({type:`dropPrimaryKey`,tableName:e,constraintName:C.name||`${e}_pkey`}),l.push({type:`addPrimaryKey`,tableName:e,primaryKey:w})),{operations:l,ambiguousChanges:u}}function u(e,t){let n=[],r=[],i=new Map(e.tables.map(e=>[e.name,e])),a=new Map(t.tables.map(e=>[e.name,e])),o=[],s=[];for(let[e]of i)a.has(e)||o.push(e);for(let[e]of a)i.has(e)||s.push(e);let u=new Set,f=new Set;for(let e of o){let t=i.get(e);for(let n of s){if(u.has(e)||f.has(n))continue;let i=a.get(n),o=new Set(t.columns.map(e=>e.name)),s=new Set(i.columns.map(e=>e.name)),c=[...o].filter(e=>s.has(e)),l=new Set([...o,...s]);c.length/l.size>=.7&&(r.push({type:`ambiguousTable`,droppedTable:e,addedTable:n}),u.add(e),f.add(n))}}for(let e of o)u.has(e)||n.push({type:`dropTable`,tableName:e});for(let e of s)if(!f.has(e)){let t=a.get(e);n.push({type:`createTable`,table:t})}for(let[e,t]of a){let a=i.get(e);if(a){let i=l(e,a,t);n.push(...i.operations),r.push(...i.ambiguousChanges)}}if(e.enums||t.enums){let r=new Map((e.enums||[]).map(e=>[e.name,e])),i=new Map((t.enums||[]).map(e=>[e.name,e]));for(let[e]of r)i.has(e)||n.push({type:`dropEnum`,enumName:e});for(let[e,t]of i)r.has(e)||n.push({type:`createEnum`,enumDef:t});for(let[e,t]of i){let i=r.get(e);if(i&&!c(i,t)){let r=t.values.filter(e=>!i.values.includes(e)),a=i.values.filter(e=>!t.values.includes(e));(r.length>0||a.length>0)&&n.push({type:`alterEnum`,enumName:e,addValues:r.length>0?r:void 0,removeValues:a.length>0?a:void 0})}}}return{operations:d(n),ambiguousChanges:r}}function d(e){let t={createEnum:1,dropForeignKey:2,dropIndex:3,dropUniqueConstraint:4,dropPrimaryKey:5,dropColumn:6,dropTable:7,createTable:8,addColumn:9,alterColumn:10,renameTable:11,renameColumn:12,addPrimaryKey:13,addUniqueConstraint:14,createIndex:15,addForeignKey:16,alterEnum:17,dropEnum:18};return[...e].sort((e,n)=>t[e.type]-t[n.type])}function f(e){return e.some(e=>e.type===`dropTable`||e.type===`dropColumn`||e.type===`alterColumn`&&(n(e.from.type)!==n(e.to.type)||e.from.nullable&&!e.to.nullable))}function p(e){let t=[];for(let r of e)r.type===`dropTable`?t.push(`Drop table "${r.tableName}" (all data will be lost)`):r.type===`dropColumn`?t.push(`Drop column "${r.columnName}" from table "${r.tableName}" (data will be lost)`):r.type===`alterColumn`&&(n(r.from.type)!==n(r.to.type)&&t.push(`Change type of "${r.tableName}"."${r.columnName}" from ${r.from.type} to ${r.to.type} (may cause data loss)`),r.from.nullable&&!r.to.nullable&&t.push(`Make "${r.tableName}"."${r.columnName}" NOT NULL (may fail if column contains NULL values)`));return t}function m(e,t){let n=[];for(let r of e){let e=t.get(r);if(!e){r.type===`ambiguousColumn`?n.push({type:`dropColumn`,tableName:r.tableName,columnName:r.droppedColumn.name},{type:`addColumn`,tableName:r.tableName,column:r.addedColumn}):r.type===`ambiguousTable`&&n.push({type:`dropTable`,tableName:r.droppedTable},{type:`createTable`,table:{name:r.addedTable,columns:[],indexes:[],foreignKeys:[],uniqueConstraints:[]}});continue}r.type===`ambiguousColumn`?e.type===`rename`?(n.push({type:`renameColumn`,tableName:r.tableName,from:r.droppedColumn.name,to:r.addedColumn.name}),(r.droppedColumn.nullable!==r.addedColumn.nullable||r.droppedColumn.default!==r.addedColumn.default)&&n.push({type:`alterColumn`,tableName:r.tableName,columnName:r.addedColumn.name,from:{...r.droppedColumn,name:r.addedColumn.name},to:r.addedColumn})):n.push({type:`dropColumn`,tableName:r.tableName,columnName:r.droppedColumn.name},{type:`addColumn`,tableName:r.tableName,column:r.addedColumn}):r.type===`ambiguousTable`&&(e.type===`rename`?n.push({type:`renameTable`,from:r.droppedTable,to:r.addedTable}):n.push({type:`dropTable`,tableName:r.droppedTable}))}return n}const h=async e=>{let t=new Map;for(let n of e)t.set(n,{type:`rename`});return t},g=async e=>{let t=new Map;for(let n of e)t.set(n,{type:`addAndDrop`});return t},_=async e=>{if(e.length>0){let t=e.map(e=>e.type===`ambiguousColumn`?`Column "${e.droppedColumn.name}" was removed and "${e.addedColumn.name}" was added in table "${e.tableName}"`:`Table "${e.droppedTable}" was removed and "${e.addedTable}" was added`);throw Error(`Ambiguous changes detected that require resolution:\n${t.join(`
`)}\n\nUse a custom resolver or the CLI interactive mode to resolve these changes.`)}return new Map};function v(e){return async t=>{let n=new Map;for(let r of t){let t=await e(r);n.set(r,{type:t})}return n}}function y(e){return async t=>{let n=new Map;for(let r of t){let t=e.find(e=>r.type===`ambiguousColumn`&&e.type===`column`?e.from===r.droppedColumn.name&&e.to===r.addedColumn.name&&(!e.tableName||e.tableName===r.tableName):r.type===`ambiguousTable`&&e.type===`table`?e.from===r.droppedTable&&e.to===r.addedTable:!1);t&&n.set(r,{type:t.resolution})}return n}}function b(e){return e.type===`ambiguousColumn`?`Column rename detected in table "${e.tableName}":\n  "${e.droppedColumn.name}" (${e.droppedColumn.type}) → "${e.addedColumn.name}" (${e.addedColumn.type})`:`Table rename detected:
  "${e.droppedTable}" → "${e.addedTable}"`}function x(e){return e.length===0?`No ambiguous changes detected.`:e.map(b).join(`

`)}function S(e,t){let n=e[`~`].nativeType;if(n&&n.db===`pg`)return t.array?`${n.type}[]`:n.type;let r;switch(t.type){case`string`:r=`text`;break;case`int`:r=t.autoGenerate===`increment`?`serial`:`integer`;break;case`float`:r=`double precision`;break;case`decimal`:r=`numeric`;break;case`boolean`:r=`boolean`;break;case`datetime`:r=`timestamptz`;break;case`date`:r=`date`;break;case`time`:r=`time`;break;case`bigint`:r=t.autoGenerate===`increment`?`bigserial`:`bigint`;break;case`json`:r=`jsonb`;break;case`blob`:r=`bytea`;break;case`vector`:r=`vector`;break;case`point`:r=`point`;break;case`enum`:r=`text`;break;default:r=`text`}return t.array?`${r}[]`:r}function C(e,t){let n=e[`~`].nativeType;if(n&&n.db===`mysql`)return n.type;switch(t.type){case`string`:return`TEXT`;case`int`:return t.autoGenerate===`increment`?`INT AUTO_INCREMENT`:`INT`;case`float`:return`DOUBLE`;case`decimal`:return`DECIMAL(65,30)`;case`boolean`:return`TINYINT(1)`;case`datetime`:return`DATETIME(3)`;case`date`:return`DATE`;case`time`:return`TIME`;case`bigint`:return t.autoGenerate===`increment`?`BIGINT AUTO_INCREMENT`:`BIGINT`;case`json`:return`JSON`;case`blob`:return`LONGBLOB`;case`enum`:return`VARCHAR(255)`;default:return`TEXT`}}function w(e,t){let n=e[`~`].nativeType;if(n&&n.db===`sqlite`)return n.type;switch(t.type){case`string`:case`enum`:case`json`:return`TEXT`;case`int`:case`bigint`:case`boolean`:return`INTEGER`;case`float`:case`decimal`:return`REAL`;case`datetime`:case`date`:case`time`:return`TEXT`;case`blob`:return`BLOB`;default:return`TEXT`}}function T(e,t,n){switch(n){case`postgresql`:return S(e,t);case`mysql`:return C(e,t);case`sqlite`:return w(e,t);default:return S(e,t)}}function E(e,t){if(e.autoGenerate)switch(e.autoGenerate){case`increment`:return;case`uuid`:return t===`postgresql`?`gen_random_uuid()`:void 0;case`now`:return t===`postgresql`?`now()`:`CURRENT_TIMESTAMP`;case`updatedAt`:return;case`ulid`:case`nanoid`:case`cuid`:return}if(e.hasDefault&&e.default!==void 0){let n=e.default;if(typeof n==`function`)return;if(n===null)return`NULL`;if(typeof n==`string`)return`'${n.replace(/'/g,`''`)}'`;if(typeof n==`number`)return String(n);if(typeof n==`boolean`)return t===`postgresql`?n?`true`:`false`:n?`1`:`0`}}function D(e){switch(e){case`cascade`:return`cascade`;case`setNull`:return`setNull`;case`restrict`:return`restrict`;case`noAction`:default:return`noAction`}}function O(e,t){let{dialect:n}=t,r=[],i=[],a=new Set;for(let[t,o]of Object.entries(e)){let e=o[`~`].state,s=o[`~`].names.sql||e.tableName||t.toLowerCase(),c=[],l=[],u=[],d=[],f,p=[];for(let[t,r]of Object.entries(e.scalars)){let e=r[`~`].state,l=o[`~`].getFieldName(t).sql;if(e.type===`enum`&&n===`postgresql`){let e=r;if(e.values&&Array.isArray(e.values)){let t=`${s}_${l}_enum`;a.has(t)||(i.push({name:t,values:e.values}),a.add(t))}}let u={name:l,type:e.type===`enum`&&n===`postgresql`?`${s}_${l}_enum`:T(r,e,n),nullable:e.nullable,default:E(e,n),autoIncrement:e.autoGenerate===`increment`};c.push(u),e.isId&&p.push(l),e.isUnique&&!e.isId&&d.push({name:`${s}_${l}_key`,columns:[l]})}if(e.compoundId){let t=Object.keys(e.compoundId);if(t.length>0){let n=t[0],r=e.compoundId[n];if(r&&r[`~`]){let e=r[`~`];e.def&&typeof e.def==`object`&&p.push(...Object.keys(e.def))}}}if(p.length>0&&(f={columns:p,name:`${s}_pkey`}),e.compoundUniques){for(let[t,n]of Object.entries(e.compoundUniques))if(n&&n[`~`]){let e=n[`~`];e.def&&typeof e.def==`object`&&d.push({name:`${s}_${t}_key`,columns:Object.keys(e.def)})}}for(let t of e.indexes){let e=t.options.name||`${s}_${t.fields.join(`_`)}_idx`;l.push({name:e,columns:t.fields,unique:t.options.unique,type:t.options.type,where:t.options.where})}for(let[t,n]of Object.entries(e.relations)){let e=n[`~`].state;if((e.type===`manyToOne`||e.type===`oneToOne`)&&e.fields&&e.references){let n=e.getter();if(n&&n[`~`]){let r=n[`~`].state,i=n[`~`].names.sql||r.tableName||t.toLowerCase();u.push({name:`${s}_${e.fields.join(`_`)}_fkey`,columns:e.fields,referencedTable:i,referencedColumns:e.references,onDelete:D(e.onDelete),onUpdate:D(e.onUpdate)})}}}r.push({name:s,columns:c,primaryKey:f,indexes:l,foreignKeys:u,uniqueConstraints:d})}return{tables:r,enums:i.length>0?i:void 0}}function k(e,t){return e[`~`].getFieldName(t).sql}function A(e,t){return e[`~`].names.sql||e[`~`].state.tableName||t.toLowerCase()}var j=class extends Error{constructor(e,t){super(e),this.code=t,this.name=`MigrationError`}};function M(t){switch(t){case`postgresql`:return e;default:throw new j(`Migrations not yet supported for dialect: ${t}`,`UNSUPPORTED_DIALECT`)}}async function N(e,t,n={}){let{force:r=!1,dryRun:i=!1,resolver:a=_}=n,o=M(e.dialect),s=O(t,{dialect:e.dialect}),c=u(await o.migrations.introspect(async(t,n)=>await e.executeRaw(t,n)),s),l=[...c.operations];if(c.ambiguousChanges.length>0){let e=await a(c.ambiguousChanges),t=m(c.ambiguousChanges,e);l.push(...t);for(let t of c.ambiguousChanges)if(t.type===`ambiguousTable`&&e.get(t)?.type===`addAndDrop`){let e=s.tables.find(e=>e.name===t.addedTable);e&&l.push({type:`createTable`,table:e})}l=P(l)}if(f(l)&&!r){let e=p(l);if(n.onDestructive){if(!await n.onDestructive(e))throw new j(`Destructive changes were not confirmed`,`DESTRUCTIVE_CHANGES_REJECTED`)}else throw new j(`Destructive changes detected:\n${e.join(`
`)}\n\nUse --force to proceed or provide an onDestructive callback.`,`DESTRUCTIVE_CHANGES`)}let d=[];for(let e of l){let t=o.migrations.generateDDL(e).split(`;
`).filter(e=>e.trim());d.push(...t)}return!i&&d.length>0&&await e.transaction(async e=>{for(let t of d)await e.executeRaw(t+`;`)}),{operations:l,applied:!i&&d.length>0,sql:d}}function P(e){let t={createEnum:1,dropForeignKey:2,dropIndex:3,dropUniqueConstraint:4,dropPrimaryKey:5,dropColumn:6,dropTable:7,createTable:8,addColumn:9,alterColumn:10,renameTable:11,renameColumn:12,addPrimaryKey:13,addUniqueConstraint:14,createIndex:15,addForeignKey:16,alterEnum:17,dropEnum:18};return[...e].sort((e,n)=>t[e.type]-t[n.type])}async function F(e){return M(e.dialect).migrations.introspect(async(t,n)=>await e.executeRaw(t,n))}async function I(e,t,n={}){let r=await N(e,t,{...n,dryRun:!0,force:!0});return{operations:r.operations,sql:r.sql}}function L(e){switch(e.type){case`createTable`:return`+ Create table "${e.table.name}" with ${e.table.columns.length} columns`;case`dropTable`:return`- Drop table "${e.tableName}"`;case`renameTable`:return`~ Rename table "${e.from}" → "${e.to}"`;case`addColumn`:return`+ Add column "${e.column.name}" (${e.column.type}) to "${e.tableName}"`;case`dropColumn`:return`- Drop column "${e.columnName}" from "${e.tableName}"`;case`renameColumn`:return`~ Rename column "${e.from}" → "${e.to}" in "${e.tableName}"`;case`alterColumn`:return`~ Alter column "${e.columnName}" in "${e.tableName}"`;case`createIndex`:return`+ Create index "${e.index.name}" on "${e.tableName}"`;case`dropIndex`:return`- Drop index "${e.indexName}"`;case`addForeignKey`:return`+ Add foreign key "${e.fk.name}" to "${e.tableName}"`;case`dropForeignKey`:return`- Drop foreign key "${e.fkName}" from "${e.tableName}"`;case`addUniqueConstraint`:return`+ Add unique constraint "${e.constraint.name}" to "${e.tableName}"`;case`dropUniqueConstraint`:return`- Drop unique constraint "${e.constraintName}" from "${e.tableName}"`;case`addPrimaryKey`:return`+ Add primary key to "${e.tableName}"`;case`dropPrimaryKey`:return`- Drop primary key "${e.constraintName}" from "${e.tableName}"`;case`createEnum`:return`+ Create enum "${e.enumDef.name}" with values [${e.enumDef.values.join(`, `)}]`;case`dropEnum`:return`- Drop enum "${e.enumName}"`;case`alterEnum`:{let t=[];return e.addValues?.length&&t.push(`add: ${e.addValues.join(`, `)}`),e.removeValues?.length&&t.push(`remove: ${e.removeValues.join(`, `)}`),`~ Alter enum "${e.enumName}" (${t.join(`; `)})`}default:return`Unknown operation: ${e.type}`}}function R(e){return e.length===0?`No changes detected.`:e.map(L).join(`
`)}export{x as _,N as a,p as b,A as c,g as d,h as f,b as g,v as h,F as i,T as l,y as m,R as n,j as o,m as p,I as r,k as s,L as t,O as u,_ as v,f as x,u as y};
//# sourceMappingURL=push-CGBkIIGQ.mjs.map